# 索引

## 1. 定义

> ​		索引是一种单独的、物理的对数据库表中一列或者多列的值进行排序的一种数据结构，它是某个表中一列或者多列的集合和相应指向数据页指针对应关系的清单。



## 2. 分类

### 2.1 物理存储角度

#### 聚集索引（聚簇索引）

​		数据行的物理顺序与索引的逻辑顺序相同，一个表中只能有一个聚集索引。聚集索引的叶节点就是数据节点，InnoDB中主键索引就是聚集索引。

**InnoDB主键生成策略**

​		优先使用用户自定义的主键作为主键，如果用户没有自定义主键，则选取一个Unique键作为主键。如果表中没有Unique键的话，则InnoDB会为表默认添加一个row_id的隐藏列作为主键。



#### 非聚集索引（非聚簇索引）

​		该索引中的索引列的逻辑顺序与磁盘上的物理存储顺序不同，一个表中可以拥有多个非聚集索引。

​		非聚集索引的叶节点仍然是索引节点，并保留一个链接指向对应的数据块。因此如果使用非聚集索引查询，而查询的列中包含了其他该索引没有覆盖的列，那么它还要进行第二次的查询，查询节点上对应数据行的数据



#### 差异

	1. 聚簇索引适合排序，非聚簇索引适合插入。这是由于两种索引不同的特性所决定的，聚簇索引插入时需要移动数据，因此插入效率较低。非聚簇索引需要消耗额外的I/O，所以查询较慢。
 	2. 聚簇索引的插入速度严重依赖于插入顺序，最好是按照主键的顺序插入。并且基于聚簇索引插入新行的时候可能面临页分裂的问题，当行的主键值要求必须将这一行插入某个已满的页中时，存储引擎会将该页分裂成两个页面来容纳该行。

[参考资料]: https://www.cnblogs.com/s-b-b/p/8334593.html
[参考资料]: https://www.cnblogs.com/wuer888/p/9552497.html



### 2.2 逻辑角度

#### 主键索引

​		在主键上建立的聚集索引。



#### 普通索引（单列索引）

​		最基本的索引，没有任何限制。



#### 唯一索引

​		与普通索引类似，不同就是，唯一索引的索引列的值必须唯一，但允许有空值。

**唯一索引和唯一性约束区别**

1.概念不同：约束是为了保证数据的完整性，索引是为了加快查询。

2.创建唯一约束时，会自动创建唯一索引



#### 多列索引（复合索引）

​		在多个字段上创建的索引，使用多列索引时需满足最左匹配原则。



#### 覆盖索引

​		SQL只需要通过索引就可以返回查询所需要的数据，而不必再回表查询。



### 2.3 从数据结构角度

#### B-Tree(B+ Tree)索引

B-Tree是索引最常用的数据结构，因为它不仅可以用在比较操作符上，还可以用在模糊查询上。



#### Hash树索引

Hash索引只能用于对等比较，例如=,<,>等操作符。但不能使用范围查询。



**区别**

	1. Hash索引等值查询快，但不支持范围搜索。
 	2. Hash索引不是顺序存储不能用于排序。
 	3. 不支持部分索引列匹配查找。
 	4. Hash冲突较多时，效率不一定高。

[参考资料]: https://blog.csdn.net/injurooioo/article/details/73506062



## 3. 数据结构

​		目前大部分数据库系统以及文件系统都采用B-Tree和B+Tree来作为索引结构。

### 3.1 原因

​		一般来说，索引本身是一个很大的文件，不可能全部存储在内存之中，因此存储在磁盘上。这样的话索引查找的过程中就要消耗磁盘IO。所以索引的结构就要在查找过程中尽可能减少磁盘IO次数。因此在使用B-Tree索引的时候，讲一个node的大小设置为一个页大小，这样每个节点就只需要一次IO就可以完全载入。一次索引的检索需要h-1次IO（根节点常驻内存）。所以以B-Tree作为索引效率非常高。



### 3.2 B-Tree和B+Tree区别

		1. B+Tree的非叶子结点不存data，这样可以存储更多的key，因此有更大的出度，磁盘读写代价更低。
  		2. B+Tree的带有data域的叶子结点都在一层，因此添加了指向相邻叶子结点的指针，形成带有顺序访问指针的B+Tree，这样做是为了提高区间查找的效率。
  		3. B+Tree所有查询都要到叶子结点，所以查询效率较为稳定，而B-Tree效率不稳定。



## 4. MySQL索引实现

### 4.1 MyISAM

​		MyISAM使用B+Tree作为索引结构，也结点的data域存放的是数据记录的地址。在MyISAM中主索引和副主索引在结构上没有任何区别，只是主索引要求key是唯一的，而辅助索引key可以重复。

![截屏2020-08-31 上午11.53.59](/Users/denakira/Desktop/myworkspace/note/SQL/picture/截屏2020-08-31 上午11.53.59.png)



### 4.2 InnoDB

​		与MyISAM不同，InnoDB的数据文件本身就是索引文件，数据是按照主键索引的结构进行存储的。因此InnoDB必须要指定主键。并且InnoDB的主键索引叶子结点包含了完整的数据记录，而不仅仅存放地址。并且除主键索引外的所有辅助索引的叶子结点的data域存储的都是主键的值。

![截屏2020-08-31 上午11.57.27](/Users/denakira/Desktop/myworkspace/note/SQL/picture/截屏2020-08-31 上午11.57.27.png)

**复合索引存放**

​		对于联合索引来说，只不过比单值索引多了几列，**而这些索引列全部都出现在索引树上**，存储引擎首先会根据第一个索引列排序，如果第一列相等再根据第二个索引列排序。

![截屏2020-08-31 下午12.16.26](/Users/denakira/Desktop/myworkspace/note/SQL/picture/截屏2020-08-31 下午12.16.26.png)

[参考资料]: https://juejin.im/post/6844904073955639304
[参考资料]: http://blog.codinglabs.org/articles/theory-of-mysql-index.html



### 4.3 MyISAM和InnoDB区别

		1. 因为InnoDB是按照主键索引的顺序存储数据文件的所以InnoDB必须要有主键，MyISAM可以没有。因此InnoDB的主键索引又称聚集索引聚簇索引。MyISAM称为非聚集索引、非聚簇索引。
  		2. MyISAM的索引data域存放的是数据的地址，而InnoDB的主键索引data域存放的是全部数据，非主键索引存放的是主键的值。



## 5. 索引优化

### 5.1 最左前缀原则

​		根据复合索引存放规则，使用索引的时候要符合最左匹配规则。对于在(a,b,c)三个列上新建的联合索引，相当于新建了(a),(a,b),(a,b,c)三个索引。所以如果查询不包含a则不会走索引，查询(a,c)只会走(a)的索引。



### 5.2 InnoDB主键选择与插入优化

​		使用InnoDB存储引擎的时候建议使用与业务无关的自增字段作为主键，因为InnoDB是按照逐渐的顺序来存储数据文件的。因此当有新纪录插入时，会按照主键将其插入到相应位置，如果页面达到装载因子，则会开辟一个新页面。如果使用自增字段，则会形成一个紧凑的索引结构，每次插入时也不需要移动已有数据，效率很高。如果不使用自增字段，则会频繁移动页面位置，进行分页。索引结构不够紧凑，浪费开销。



### 5.3 其他

		1. 使用区别大的字段作为索引列。
  		2. 尽量使用覆盖索引，避免回表查询。