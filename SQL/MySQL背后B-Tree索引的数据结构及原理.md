# MySQL背后B-Tree索引的数据结构及原理

## 数据结构及算法基础

> 索引是帮助MySQL高效获取数据的数据结构。

### B-Tree和B+Treee

**B-Tree和B+Tree的区别**

1.B+Tree的内节点不存储data只存储key。因此单一节点存储元素更多，使得IO次数更少，B+Tree相比于B-Tree更加的“矮胖”，更适合作为数据库底层数据结构。

2.B+Tree所有查询都要查询到叶子结点，所以查询性能是稳定的。而B树，每个节点都可以查询到数据，所以不稳定。

3.B+Tree所有叶子结点可以形成一个有序链表，提升区间访问性能。

### 带有顺序访问指针的B+Tree

一般在数据库系统或文件系统中使用的B+Tree结构都在经典B+Tree的基础上进行了优化，增加了顺序访问指针。

![截屏2020-04-02下午7.03.27](/Users/denakira/Desktop/myworkspace/note/SQL/picture/截屏2020-04-02下午7.03.27.png)

每个B+Tree的每个叶子结点都增加一个指向相邻叶子结点的指针，就形成了带有顺序访问指针的B+Tree。做这个优化的目的是提高区间访问的性能。

## 为什么使用B-Tree（B+Tree）

​		一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以文件的形式存储在磁盘上，因此索引的查找就会消耗磁盘的I/O。因此将B-Tree的一个节点大小设计为等于内存中的页大小，这样每个节点只需要一次I/O就可以完全载入。所以在B-Tree中一次检索最多只需要h-1次I/O（根结点常驻内存）。综上所述，使用B-Tree作为索引结构效率是非常高的。

## MySQL索引实现

在MySQL中，索引属于引擎级别的概念，不同的存储引擎对索引的实现方式是不同的。

### MyISAM索引实现

MyISAM使用B+Tree作为索引结构，叶节点的data域存放的是数据记录的地址。因此MyISAM的索引也称为非聚集索引。

![截屏2020-04-02下午7.13.28](/Users/denakira/Desktop/myworkspace/note/SQL/picture/截屏2020-04-02下午7.13.28.png)



### InnoDB索引实现

InnoDB也适用B+Tree作为索引结构，但实现方式与MyISAM有很大不同。

1.第一个重大区别就是InnoDB的数据文件本身就是索引文件，MyISAM的索引文件和数据文件是分开的，索引文件仅保存数据记录的地址。而在InnoDB中，表数据文件本身就是按照B+Tree组织的一个索引结构，这棵树的叶节点的data域保存了完整的数据记录。这个索引的key是数据表的主键，因此InnoDB表数据文件本身就是聚集索引。

![截屏2020-04-02下午7.17.20](/Users/denakira/Desktop/myworkspace/note/SQL/picture/截屏2020-04-02下午7.17.20.png)

因为InnoDB的数据文件本身要按照主键聚集，因此InnoDB要求表必须有主键。

**主键选择与插入优化**

在使用InnoDB存储引擎的时候，如果没有特别需要，最好使用与业务无关的自增字段作为主键。

如果使用自增主键，每次插入记录，记录就以顺序添加到当前索引节点的后续位置，当一页写满，就会自动开辟一个新的页，这样就会形成一个紧凑的索引结构，并且每次插入也不需要移动数据效率很高。

如果使用非自增主键，每次插入主键的值近似于随机，因此每次新纪录都会查到索引页的中间某个位置，此时MySQL不得不移动数据，降低效率，同时增加了很多的分页碎片，结构不够紧凑。

[参考资料]: http://blog.codinglabs.org/articles/theory-of-mysql-index.html

