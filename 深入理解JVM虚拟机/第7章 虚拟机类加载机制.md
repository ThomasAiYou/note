# 第7章 虚拟机类加载机制

> 虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的Java类型，这就是虚拟机的类加载机制。

## 7.2 类加载的时机

​		类从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期包括：加载、验证、准备、解析、初始化、使用、卸载。其中验证、准备、解析三个部分统称连接。![截屏2020-04-26上午9.20.28](/Users/denakira/Desktop/myworkspace/note/深入理解JVM虚拟机/picture/截屏2020-04-26上午9.20.28.png)



## 7.3 类加载的过程

### 7.3.1 加载

​		在加载阶段，虚拟机要完成以下3件事：

1.通过类的全限定名来获取定义此类的二进制字节流。

2.将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。

3.在内存中生成一个代表着这个类的对象，作为方法区这个类的各种数据的访问入口。

### 7.3.2 验证

​		验证的目的是为了确保class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。

1.文件格式验证2.元数据验证3.字节码验证4.符号引用验证。

### 7.3.3 准备

​		准备阶段是正式为类变量分配内存并设置类变量初始值的阶段。这时候内存分配的仅包括类变量(被static修饰的变量)，而不包括实例变量。其次初始值通常情况下是数据类型的零值。假设一个变量定义如下

```java
public static int value = 123;			
```

那变量value在准备阶段过后的初始值为0而不是123，这是因为尚未开始执行任何Java方法。

### 7.3.4 解析

​		解析阶段是虚拟机将常量池内的符号引用转换为直接引用的过程。

符号引用：符号引用是以一组符号来描述所引用的目标。

直接引用：直接引用可以是直接指向目标的指针、相对偏移量、或是一个能间接定位到目标的句柄。

​		解析包括：1.类或接口的解析。2.字段解析。3.类方法解析。4.接口方法解

### 7.3.5 初始化

​		到了初始化阶段才真正的开始执行类中定义的Java程序代码。



## 7.4 类加载器

> 通过一个类的全限定名来获取描述此类的二进制字节流的模块。

### 7.4.1 类与类加载器

​		对于任意一个类都需要由加载它的类加载器和这个类本身一同确立其在Java虚拟机中的唯一性，每一个类加载器，都拥有一个独立的类名称空间。比较两个类是否相等，只有在这两个类是由同一个类加载器加载的前提下才有意义。否则，即使这两个类来源于同一个class文件，被同一个虚拟机加载，只要加载它们的类加载器不同，这两个类就必定不相等。

### 7.4.2 双亲委派模型

​		从Java虚拟机的角度来讲，存在三种种不同的类加载器：

第一种是启动类加载器：负责将<JAVA_HOME>/lib中的类库加载到虚拟机的内存中，开发者无法直接使用。

第二种是拓展类加载器：负责加载<JAVA_HOME>/lib/ext目录中的所有类库。

第三种是应用程序类加载器：负责加载用户类路径所指定的类库。

​		双亲委派模型要求除了启动类加载器外，其余的类加载器都应当有自己的父类加载器。如果一个类加载器收到了类加载的请求，他首先不会自己去尝试加载这个类，而是把这个请求委托给父类加载器去完成，只有当父类加载器反馈自己无法完成这个加载请求时，子类加载器才会自己尝试加载。